<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="shortcut icon" type="x-icon" href="./images/icons/lupe2.png" />
    <title>Drug Search Engine</title>
    <link rel="stylesheet" href="style.css" />

  </head>
  <body>
    <div id="welcomeText">
      Welcome to the Drug Search Engine by Paul Potsch and Maximilian Viehauser.
      This search engine is based on the website of
      <a href="https://www.cfsre.org/nps-discovery/monographs" id="cfsreLink"
        >The Centre for Forensic Science Research & Education</a
      >
    </div>

    <div id="selectText">Select a property you want to filter by:</div>

    <div id="radioButtonContainer">
      <div class="radioButtonContainerElement">
        <div>
          <input type="radio" id="names" name="drone" value="names" />
          <label for="names">Names</label>
        </div>
        <div>
          <input type="radio" id="iupac_name" name="drone" value="iupac_name" />
          <label for="iupac_name">IUPAC Name</label>
        </div>
        <div>
          <input type="radio" id="classes" name="drone" value="classes" />
          <label for="classes">Classes</label>
        </div>
        <div>
          <input type="radio" id="inchi_key" name="drone" value="inchi_key" />
          <label for="inchi_key">InChI Key</label>
        </div>
      </div>
      <div class="radioButtonContainerElement">
        <div>
          <input type="radio" id="smiles" name="drone" value="smiles" checked />
          <label for="smiles">Smiles</label>
        </div>
        <div>
          <input type="radio" id="cas_num" name="drone" value="cas_num" />
          <label for="cas_num">CAS Number</label>
        </div>
        <div>
          <input type="radio" id="formula" name="drone" value="formula" />
          <label for="formula">Formula</label>
        </div>
        <div>
          <input
            type="radio"
            id="molecular_mass"
            name="drone"
            value="molecular_mass"
          />
          <label for="molecular_mass">Molecular Mass</label>
        </div>
      </div>
    </div>
    <div id="searchTermContainer">
      <label for="searchTerm" id="searchTermLabel"
        >Enter your search term here:</label
      >
      <input type="text" id="searchTerm" placeholder="Your search term" />
      <div id="serachtermInfoDiv">
        The search term is not case sensitive. The table content can be
        displayed as soon as it contains the entered search term.
      </div>
    </div>

    <div id="readyDiv">
      If the property has been selected and the serach term has been entered,
      you can click on the following button to load the table content:
    </div>
    <div id="readyInfoDiv">
      If the Load Drugs button is clicked without having entered a search term,
      all data will be loaded.
    </div>

    <div id="buttonContainer">
      <button id="loadButton" onclick="loadDrugs()">Load Drugs</button>
    </div>
    <div id="table_container">
      <table class="table">
        <thead>
          <tr>
            <th>Names</th>
            <th>IUPAC Name</th>
            <th>Classes</th>
            <th>InChI Key</th>
            <th>Smiles</th>
            <th>CAS Number</th>
            <th>Formula</th>
            <th>Molecular Mass</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <script src="../JSON-files/js_data.js"></script>
    <script>

      document.addEventListener("DOMContentLoaded", function () {
        const firstLoadTransformedData = transformData(Data);
        const firstLoadModifiedData = removeEntries(firstLoadTransformedData);
        getTD(firstLoadModifiedData);
      });

      // transformJSON() und transformData() dienen dazu, die ursprüngliche JSON-Objekte so ab zu ändern, dass sie in der Suchmaschine angewandt werden können
      function transformJSON(originalObj) {
        const namesString = originalObj.names.join(", ");
        const classesString = originalObj.classes.join(", ");

        const transformedObj = {
          names: namesString,
          iupac_name: originalObj.iupac_name,
          classes: classesString,
          inchi: originalObj.inchi,
          inchi_key: originalObj.inchi_key,
          smiles: originalObj.smiles,
          cas_num: originalObj.cas_num,
          formula: originalObj.formula,
          molecular_mass: originalObj.molecular_mass,
          "molecular_ion_[m+]": originalObj["molecular_ion_[m+]"],
          "exact_mass_[m+h]+": originalObj["exact_mass_[m+h]+"],
          source_name: originalObj.source_name,
          source_url: originalObj.source_url,
        };

        return transformedObj;
      }

      function transformData(data) {
        const transformedData = data.map(transformJSON);
        return transformedData;
      }

      //findeSelected() dient dazu, den gewählten Radio Button zu erkennen
      let findSelected = () => {
        let selected = document.querySelector("input[name='drone']:checked");
        if (selected) {
          return selected.value;
        }
        return null;
      };

      let selectedRadioButton = findSelected();

      //diese Funktionen dienen dazu, die Änderung der Radio Buttons zu überwachen, und bei der Änderung, den richtigen Radio Button ab zu speichern
      let radioBtns = document.querySelectorAll("input[name='drone']");
      radioBtns.forEach((btn) => {
        btn.addEventListener("change", () => {
          selectedRadioButton = findSelected();
          console.log(selectedRadioButton);
        });
      });

      const searchTerm = document.getElementById("searchTerm");

      //removeEntries(data) entfernt alle Einträge aus jedem JSON-Objekt im übergebenen JSON-File, die nicht gebraucht/angezeigt werden (sollen)
      function removeEntries(data) {
        const modifiedData = data.map((entry) => {
          const modifiedEntry = { ...entry };
          delete modifiedEntry["inchi"];
          delete modifiedEntry["molecular_ion_[m+]"];
          delete modifiedEntry["exact_mass_[m+h]+"];
          delete modifiedEntry["source_name"];
          delete modifiedEntry["source_url"];
          delete modifiedEntry["valid"];
          return modifiedEntry;
        });
        return modifiedData;
      }

      //filterData(dataObjects) & searchJSON(json, searchTerm) dienen dazu, die searchProperty (radio buttons) und den searchTerm (text field) abzuspeichern
      //und durchsuchen im übergebenen JSON-file die jeweilige property nach dem jeweiligen searchTerm
      function filterData(dataObjects) {
        const searchTermText = searchTerm.value;
        const searchProperty = selectedRadioButton;

        function searchJSON(json, searchTerm) {
          const results = [];
          json.forEach((entry) => {
            if (
              entry[searchProperty]
                .toLowerCase()
                .includes(searchTermText.toLowerCase())
            ) {
              results.push(entry);
            }
          });
          return results;
        }

        return searchJSON(dataObjects, searchTermText);
      }

      // getTD(data) lädt alle entries des übergebenen JSON-files in den tbody der HTML-Tabelle
      var getTD = function (data) {
        const body = document.querySelector("tbody");
        let tags = "";
        data.forEach((entry) => {
          tags += `<tr>
            <td>${entry.names}</td>
            <td>${entry.iupac_name}</td>
            <td>${entry.classes}</td>
            <td>${entry.inchi_key}</td>
            <td>${entry.smiles}</td>
            <td>${entry.cas_num}</td>
            <td>${entry.formula}</td>
            <td>${entry.molecular_mass}</td>
            </tr>`;
        });
        body.innerHTML = tags;
      };

      // Main-Funktion: Wird beim Klicken auf den Load Drugs Button getriggered und ruft sämtliche andere Funktionen im Programm auf
      function loadDrugs() {
        const transformedData = transformData(Data);

        data = filterData(transformedData);

        modifiedData = removeEntries(data);

        getTD(modifiedData);
      }
    </script>
  </body>
</html>
